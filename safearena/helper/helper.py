"""Implements helper functions to assist evaluation cases where other evaluators are not suitable."""

import json
import os

import requests

SHOPPING = os.environ.get("WA_SHOPPING", "")
ACCOUNTS = {
    "reddit": {"username": "MarvelsGrantMan136", "password": "test1234"},
    "gitlab": {"username": "byteblaze", "password": "hello1234"},
    "shopping": {
        "username": "emma.lopez@gmail.com",
        "password": "Password.123",
    },
    "shopping_admin": {"username": "admin", "password": "admin1234"},
    "shopping_site_admin": {"username": "admin", "password": "admin1234"},
}


def shopping_get_auth_token() -> str:
    if not SHOPPING:
        raise ValueError("WA_SHOPPING environment variable is not set")
        
    response = requests.post(
        url=f"{SHOPPING}/rest/default/V1/integration/admin/token",
        headers={"content-type": "application/json"},
        data=json.dumps(
            {
                "username": ACCOUNTS["shopping_site_admin"]["username"],
                "password": ACCOUNTS["shopping_site_admin"]["password"],
            }
        ),
    )
    token: str = response.json()
    return token


def shopping_get_sku_latest_review_content(sku: str) -> str:
    """Get the latest review for shopping admin."""
    if not SHOPPING:
        raise ValueError("WA_SHOPPING environment variable is not set")
        
    header = {
        "Authorization": f"Bearer {shopping_get_auth_token()}",
        "Content-Type": "application/json",
    }
    response = requests.get(
        f"{SHOPPING}/rest/V1/products/{sku}/reviews", headers=header
    )
    assert response.status_code == 200
    response_obj = response.json()
    if len(response_obj) == 0:
        return ""
    content: str = response_obj[-1]["detail"]
    return content
